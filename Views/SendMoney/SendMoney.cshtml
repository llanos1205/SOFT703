@model SOFT703.Models.ViewModels.SendMoneyViewModel

@{
    ViewBag.Title = "Send Money";
    Layout = "_Layout";
}

<form asp-controller="SendMoney" asp-action="SendMoney" method="post">
    <div class="form-group">
        <label for="SelectedAgentId">Select Agent</label>
        <select asp-for="SelectedAgentId" class="form-control" id="SelectedAgentId">
            @foreach (var agent in Model.Agents)
            {
                <option value="@agent.Value">@agent.Text</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="SelectedSenderCountryId">Sender Country</label>
        <select asp-for="SelectedSenderCountryId" class="form-control" id="SelectedSenderCountryId">
            @foreach (var country in Model.SenderCountries)
            {
                <option value="@country.Value">@country.Text</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="SelectedReceiverCountryId">Receiver Country</label>
        <select asp-for="SelectedReceiverCountryId" class="form-control" id="SelectedReceiverCountryId">
            @foreach (var country in Model.ReceiverCountries)
            {
                <option value="@country.Value">@country.Text</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="ExchangeRate">Exchange Rate</label>
        <p id="ExchangeRateLabel">@Model.ExchangeRate</p>
    </div>

    <div class="form-group">
        <label for="AmountToSend">Amount to Send</label>
        <input asp-for="AmountToSend" class="form-control" id="AmountToSend" />
    </div>
    <div class="form-group">
        <label for="TotalConversion">Total Conversion</label>
        <p id="TotalConversionLabel">@Model.TotalConversion</p>
    </div>
    <input type="hidden" id="ExchangeRate" value="@Model.ExchangeRate" />

    <button type="submit" class="btn btn-primary">Send Money</button>
</form>

@section Scripts {
    <script>
       $(document).ready(function () {
           // Initialize the Exchange Rate label
           var exchangeRate = parseFloat($('#ExchangeRate').val()) || 1.00;
           $('#ExchangeRateLabel').text(exchangeRate.toFixed(2));
       
           // Handle input change event for the "Amount to Send" input
           $('#AmountToSend').on('input', function () {
               exchangeRate = parseFloat($('#ExchangeRate').val()) || 1.00;
               var amountToSend = parseFloat($(this).val()) || 0.00;
               var totalConversion = (exchangeRate * amountToSend).toFixed(2);
               $('#TotalConversionLabel').text(totalConversion);
           });
       
           // Handle change events of sender and receiver country select elements
           $('#SelectedSenderCountryId, #SelectedReceiverCountryId').change(function () {
               var senderCountryId = $('#SelectedSenderCountryId').val();
               var receiverCountryId = $('#SelectedReceiverCountryId').val();
       
               if (senderCountryId === receiverCountryId) {
                   // Countries are the same, set the Exchange Rate to 1.00
                   $('#ExchangeRateLabel').text('1.00');
               } else {
                   // Send an AJAX request to fetch the Exchange Rate from the server
                   $.ajax({
                       url: '/SendMoney/GetExchangeRate',
                       method: 'GET',
                       data: {
                           senderCountryId: senderCountryId,
                           receiverCountryId: receiverCountryId,
                           agentId: $('#SelectedAgentId').val()
                       },
                       success: function (data) {
                           // Update the Exchange Rate label in the view
                           $('#ExchangeRateLabel').text(data.exchangeRate);
       
                           // Update the hidden input field with the new exchange rate
                           $('#ExchangeRate').val(data.exchangeRate);
                       },
                       error: function () {
                           $('#ExchangeRateLabel').text('N/A');
                       }
                   });
               }
           });
       });
    </script>
}
